<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>GG在线聊天 - 实时聊天</title>
    <link rel="stylesheet" href="/static/cdn/element-ui/2.15.1/theme-chalk/index.min.css">
    <script src="/static/cdn/vue/2.6.11/vue.min.js"></script>
    <script src="/static/cdn/element-ui/2.15.1/index.js"></script>
    <script src="/static/cdn/jquery/3.6.0/jquery.min.js"></script>

    <style>
        body {
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .signin {
            width: 350px;
            padding: 20px;
            background: #fff;
            -webkit-box-shadow: 0 1px 2px 0 rgba(101,129,156,.08);
            box-shadow: 0 1px 2px 0 rgba(101,129,156,.08);
            border-radius: 4px;
        }
        .signin h1, .signin h2, .signin .copyright {
            font-weight: normal;
            color: #4d627b;
            text-align: center;
        }
        .signin .loginTitle {
            font-size: 22px;
            margin: 20px 0px;
        }
        .signin .copyright {
            font-size: 12px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .signin {
                width: 90%;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
<div id="app" class="signin">
    <template>
        <div class="loginHtml">
            <h1 class="loginTitle">GG 在线聊天</h1>
            <el-form :model="form" :rules="rules" ref="loginForm" v-show="!showRegHtml">
                <el-form-item prop="account">
                    <el-input v-model="form.account" placeholder="请输入用户名"></el-input>
                </el-form-item>
                <el-form-item prop="password">
                    <el-input show-password v-on:keyup.enter.native="handleLogin('loginForm')" v-model="form.password" placeholder="请输入密码"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-button style="width: 100%" type="primary" @click="handleLogin('loginForm')">登录</el-button>
                </el-form-item>
<!--                <el-form-item>-->
<!--                    <el-button style="width: 100%" @click="showRegHtml=true">创建新账号</el-button>-->
<!--                </el-form-item>-->
            </el-form>

            <el-form :model="form" :rules="rules" ref="registerForm" v-show="showRegHtml">
                <el-form-item prop="account">
                    <el-input v-model="form.account" placeholder="请输入用户名"></el-input>
                </el-form-item>
                <el-form-item prop="nickname">
                    <el-input v-model="form.nickname" placeholder="设置显示名称"></el-input>
                </el-form-item>
                <el-form-item prop="password">
                    <el-input show-password v-model="form.password" placeholder="设置密码"></el-input>
                </el-form-item>
                <el-form-item prop="rePassword">
                    <el-input show-password v-on:keyup.enter.native="handleRegister('registerForm')" v-model="form.rePassword" placeholder="确认密码"></el-input>
                </el-form-item>
<!--                <el-form-item>-->
<!--                    <el-button style="width: 100%" type="primary" @click="handleRegister('registerForm')">注册</el-button>-->
<!--                </el-form-item>-->
                <el-form-item>
                    <el-button style="width: 100%" @click="showRegHtml=false">返回登录</el-button>
                </el-form-item>
            </el-form>
        </div>

        <p class="copyright">GG 在线聊天 - 实时聊天平台</p>
    </template>
</div>
</body>
<script>
    new Vue({
        el: '#app',
        delimiters: ["<{", "}>"],
        data: {
            form: {
                account: "",
                password: "",
                rePassword: "",
                nickname:"",
            },
            rules: {
                account: [
                    { required: true, message: '请输入用户名', trigger: 'blur' },
                    { min: 2, max: 20, message: '用户名长度为2-20个字符', trigger: 'blur' }
                ],
                nickname: [
                    { required: true, message: '请输入显示名称', trigger: 'blur' },
                    { min: 1, max: 60, message: '显示名称长度为1-60个字符', trigger: 'blur' }
                ],
                password: [
                    { required: true, message: '请输入密码', trigger: 'blur' },
                    { min: 2, message: '密码长度至少2个字符', trigger: 'blur' }
                ],
                rePassword: [
                    { required: true, message: '请确认密码', trigger: 'blur' },
                    { validator: this.validatePasswordMatch, trigger: 'blur' }
                ]
            },
            showRegHtml: false,
        },
        methods: {
            validatePasswordMatch(rule, value, callback) {
                if (value !== this.form.password) {
                    callback(new Error('两次输入的密码不一致'));
                } else {
                    callback();
                }
            },

            handleLogin(formName) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        this.login();
                    }
                });
            },

            handleRegister(formName) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        this.register();
                    }
                });
            },

            login() {
                let data = {
                    "username": this.form.account,
                    "password": this.form.password,
                };

                $.post("/check", data, (response) => {
                    if (response.code === 200) {
                        this.$message({
                            message: '欢迎回来！',
                            type: 'success'
                        });
                        localStorage.setItem("token", response.result.token);
                        window.location.href = "/main";
                    } else {
                        this.$message({
                            message: response.message || '用户名或密码错误',
                            type: 'error'
                        });
                    }
                }).fail(() => {
                    this.$message({
                        message: '连接错误，请稍后重试',
                        type: 'error'
                    });
                });
            },

            register() {
                if (this.form.password !== this.form.rePassword) {
                    this.$message({
                        message: '两次输入的密码不一致',
                        type: 'error'
                    });
                    return;
                }

                let data = {
                    "username": this.form.account,
                    "password": this.form.password,
                    "nickname": this.form.nickname,
                };

                $.post("/register", data, (response) => {
                    if (response.code === 200) {
                        this.$message({
                            message: '注册成功！',
                            type: 'success'
                        });
                        this.showRegHtml = false;
                    } else {
                        this.$message({
                            message: response.msg || '注册失败',
                            type: 'error'
                        });
                    }
                }).fail(() => {
                    this.$message({
                        message: '连接错误，请稍后重试',
                        type: 'error'
                    });
                });
            }
        },
        created: function() {
            if (top.location != location) {
                top.location.href = location.href;
            }
        }
    });
</script>
</html>
